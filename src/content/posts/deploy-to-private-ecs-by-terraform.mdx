---
title: "terraformã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«ECSã‚’ä½œã‚‹"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
tags: ["AWS", "Terraform"]
published: true
published_at: 2023-08-05 19:40
---

# ã¯ã˜ã‚ã«

ECS ã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«ç½®ã„ã¦ã€LB ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã«ç½®ãã‚ˆã†ãªæ§‹æˆã¯ã‚ˆãã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã®éš›ã€ECS ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«ã„ã‚‹ã®ã§ã€ãã®ã¾ã¾ã ã¨ ECR ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚Šã€CW Logs ã«ãƒ­ã‚°ã‚’åã„ãŸã‚Šã§ãã¾ã›ã‚“ã€‚
ãã®ã¨ãã®å¯¾å‡¦æ³•ã¨ã—ã¦ã€ä»¥ä¸‹ã® 2 ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã™:

1. ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã« NAT Gateway ã‚’ç½®ãã€NAT Gateway çµŒç”±ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«æ¥ç¶šã—ã€AWS ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
2. VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(VPCE)çµŒç”±ã§ VPC å¤–ã® AWS ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

1 ã®å ´åˆã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ã‚·ãƒ³ãƒ—ãƒ«ã« NAT Gateway ãŒé«˜ã„ã¨ã„ã†ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
VPCE ã®å ´åˆã¯ã‚‚ã†å°‘ã—å®‰ã‚ã«æ¸ˆã‚€ã®ã«åŠ ãˆã€é€šä¿¡ãŒ AWS ä¸Šã‹ã‚‰å‡ºãªã„ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚å„ªã‚Œã¦ã‚‹ã¨è¨€ãˆã¾ã™ã€‚

| ã‚„ã‚Šæ–¹             | æ–™é‡‘                                                             | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£                                      | è¨­å®šã®é›£æ˜“åº¦                                                                           |
| ------------------ | ---------------------------------------------------------------- | ------------------------------------------------- | -------------------------------------------------------------------------------------- |
| NAT GW | é«˜ã„ | ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§æ¥ç¶š | ç°¡å˜ |
| VPCE | NAT GWã‚ˆã‚Šã¯å®‰ã„ | AWS ç’°å¢ƒå†…ã§æ¥ç¶šãŒå®Œçµã™ã‚‹                        | ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«VPCEã‚’ç«‹ã¦ã‚‹å¿…è¦ãŒã‚ã‚‹ |

è©³ã—ã„ã‚³ã‚¹ãƒˆã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ï¼š

https://blog.jicoman.info/2020/02/cost-optimization-aws-network/

# ã‚„ã‚ŠãŸã„ã“ã¨

ä»Šå›ã‚„ã‚ŠãŸã„ã“ã¨ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- ECS ã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã«ç«‹ã¦ã‚‹
- ECS ã‹ã‚‰ ECR, CW Logs, S3, SSM ãªã©ã¸ã®é€šä¿¡ã‚’ VPCE çµŒç”±ã§è¡Œã†
- ECS Exec ã§ç¨¼åƒä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã™ã‚‹

# æ§‹æˆå›³

ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã‚’`terraform`ã§ä½œã‚Šã¾ã™ã€‚

![æ§‹æˆå›³](/images/compressed-images/private-ecs.png)

# ä½œã£ã¦ã„ã

## vpce ã«ã¤ã„ã¦

ECS ã‚’ private subnet ã«ç«‹ã¦ã‚‹ãŸã‚ã«ã¯æœ€ä½é™ 3 ã¤ã® vpce ã‚’ç«‹ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã•ã‚‰ã« vpce ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

| vpc ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                    | ç¨®é¡         |  å¿…é ˆã‹ |
| ------------------------------------- | ------------ | ---------- |
| com.amazonaws.(region).ecr.api        | IF | â—¯ |
| com.amazonaws.(region).ecr.dkr        | IF | â—¯|
| com.amazonaws.(region).s3             | GW | â—¯ |
| com.amazonaws.(region).logs           | IF | âœ— |
| com.amazonaws.(region).secretsmanager | IF | âœ— |
| com.amazonaws.(region).ssm            | IF | âœ— |
| com.amazonaws.(region).ssmmessages    | IF | âœ— |

è©³ã—ãã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™

https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/vpc-endpoints.html

## ã‚³ãƒ¼ãƒ‰ã®å…¨ä½“åƒ

```hcl:network/main.tf
locals {
  az = ["(az1)", "(az2)"]
}

resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true # ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«DNSãƒ›ã‚¹ãƒˆåã‚’ä»˜ä¸ã™ã‚‹
  enable_dns_support   = true # VPCå†…ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«DNSã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹

  tags = {
    Name = "main"
  }
}

resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "main"
  }
}

resource "aws_subnet" "publics" {
  count             = 2
  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index)
  availability_zone = local.az[count.index]

  tags = {
    Name = "public-${local.az[count.index]}"
  }
}

resource "aws_subnet" "privates" {
  count             = 2
  vpc_id            = aws_vpc.main.id
  cidr_block        = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index + 2)
  availability_zone = local.az[count.index]

  tags = {
    Name = "private-${local.az[count.index]}"
  }
}

resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }
}

resource "aws_route_table_association" "public" {
  count          = 2
  subnet_id      = aws_subnet.publics[count.index].id
  route_table_id = aws_route_table.public.id
}

resource "aws_route_table" "private" {
  vpc_id = aws_vpc.main.id
}

# s3ã¸ã®vpceã¯Gatewayå‹ãªã®ã§ã€route tableã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
resource "aws_vpc_endpoint" "s3" {
  vpc_id          = aws_vpc.main.id
  service_name    = "com.amazonaws.(region).s3"
  route_table_ids = [aws_route_table.private.id]

  tags = {
    Name = "s3_vpce"
  }
}

resource "aws_route_table_association" "private" {
  count          = 2
  subnet_id      = aws_subnet.privates[count.index].id
  route_table_id = aws_route_table.private.id
}

resource "aws_security_group" "vpce" {
  name        = "vpce"
  description = "vpce"
  vpc_id      = aws_vpc.main.id

  # HTTPSã®ã¿è¨±å¯ã™ã‚Œã°ã„ã„
  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = [aws_vpc.main.cidr_block] # vpcå†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_vpc_endpoint" "ecr_dkr" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.(region).ecr.dkr"
  vpc_endpoint_type   = "Interface"
  private_dns_enabled = true
  subnet_ids          = aws_subnet.privates[*].id
  security_group_ids  = [aws_security_group.vpce.id]

  tags = {
    Name = "ecr_dkr_vpce"
  }
}

resource "aws_vpc_endpoint" "ecr_api" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.(region).ecr.api"
  vpc_endpoint_type   = "Interface"
  private_dns_enabled = true
  subnet_ids          = aws_subnet.privates[*].id
  security_group_ids  = [aws_security_group.vpce.id]

  tags = {
    Name = "ecr_api_vpce"
  }
}

resource "aws_vpc_endpoint" "cloudwatch_logs" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.(region).logs"
  vpc_endpoint_type   = "Interface"
  private_dns_enabled = true
  subnet_ids          = aws_subnet.privates[*].id
  security_group_ids  = [aws_security_group.vpce.id]

  tags = {
    Name = "cloudwatch_logs_vpce"
  }
}

resource "aws_vpc_endpoint" "ssmmessages" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.(region).ssmmessages"
  vpc_endpoint_type   = "Interface"
  private_dns_enabled = true
  subnet_ids          = aws_subnet.privates[*].id
  security_group_ids  = [aws_security_group.vpce.id]

  tags = {
    Name = "ssmmessages_vpce"
  }
}

resource "aws_vpc_endpoint" "ssm" {
  vpc_id              = aws_vpc.main.id
  service_name        = "com.amazonaws.(region).ssm"
  vpc_endpoint_type   = "Interface"
  private_dns_enabled = true
  subnet_ids          = aws_subnet.privates[*].id
  security_group_ids  = [aws_security_group.vpce.id]

  tags = {
    Name = "ssm_vpce"
  }
}

```

## ALB

```hcl:alb/main.tf
resource "aws_lb" "main" {
  name               = "main"
  internal           = false
  subnets            = var.public_subnet_ids
  security_groups    = [aws_security_group.alb.id]
  load_balancer_type = "application"

  tags = {
    Name = "main"
  }
}

resource "aws_security_group" "alb" {
  name        = "alb"
  description = "alb"
  vpc_id      = var.vpc_id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_lb_listener" "main" {
  load_balancer_arn = aws_lb.main.arn
  port              = 80
  protocol          = "HTTP"

  default_action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.main.arn
  }
}

resource "aws_lb_target_group" "main" {
  name        = "main"
  port        = 80
  protocol    = "HTTP"
  vpc_id      = var.vpc_id
  target_type = "ip"

  health_check {
    path = "/"
  }
}

```

## ECS

```hcl:ecs/main.tf
resource "aws_iam_role" "nginx_task_role" {
  name = "nginx_ecs_task_role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ecs-tasks.amazonaws.com"
        }
      }
    ]
  })

  # ECS TaskãŒSSMã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ECS Execã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  inline_policy {
    name = "ecs_exec"
    policy = jsonencode({
      Version = "2012-10-17"
      Statement = [
        {
          Action = [
            "ssmmessages:CreateControlChannel",
            "ssmmessages:CreateDataChannel",
            "ssmmessages:OpenControlChannel",
            "ssmmessages:OpenDataChannel"
          ]
          Effect   = "Allow"
          Resource = "*"
        }
      ]
    })
  }
}

# ECSã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½¿ã†IAMãƒ­ãƒ¼ãƒ«
# ECSã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å½¹å‰²ã¯ã€ECRãªã©ã‹ã‚‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®pullã‚„ã€CloudWatch Logsã¸ã®ãƒ­ã‚°ã®æ›¸ãè¾¼ã¿ãªã©
resource "aws_iam_role" "nginx_execution_role" {
  name = "nginx_ecs_execution_role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ecs-tasks.amazonaws.com"
        }
      }
    ]
  })

  managed_policy_arns = [
    "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
  ]
}



resource "aws_ecs_cluster" "main" {
  name = "main"
}

resource "aws_ecs_task_definition" "nginx" {
  family                   = "main"
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]
  cpu                      = "256"
  memory                   = "512"
  task_role_arn            = aws_iam_role.nginx_task_role.arn
  execution_role_arn       = aws_iam_role.nginx_execution_role.arn

  container_definitions = jsonencode(
    [
      {
        "name" : "nginx",
        "image" : "(ecrã®uri)",
        "essentials" : true,
        "logConfiguration" : {
          "logDriver" : "awslogs",
          "options" : {
            "awslogs-group" : aws_cloudwatch_log_group.ecs.name,
            "awslogs-region" : "(region)",
            "awslogs-stream-prefix" : "ecs"
          }
        },
        "portMappings" : [
          {
            "containerPort" : 80,
            "hostPort" : 80,
            "protocol" : "tcp"
          }
        ],
      }
    ]
  )
}

resource "aws_security_group" "ecs" {
  name        = "ecs"
  description = "ecs"
  vpc_id      = var.vpc_id

  ingress {
    from_port       = 80
    to_port         = 80
    protocol        = "tcp"
    security_groups = [var.aws_lb_security_group_id]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_ecs_service" "main" {
  name                   = "main"
  cluster                = aws_ecs_cluster.main.id
  task_definition        = aws_ecs_task_definition.nginx.arn
  desired_count          = 1
  launch_type            = "FARGATE"
  enable_execute_command = true # ECS Execã‚’æœ‰åŠ¹åŒ–

  deployment_controller {
    type = "CODE_DEPLOY"
  }

  network_configuration {
    assign_public_ip = false
    subnets          = var.private_subnet_ids
    security_groups  = [aws_security_group.ecs.id]
  }

  load_balancer {
    target_group_arn = var.aws_lb_target_group_arn
    container_name   = "nginx"
    container_port   = 80
  }

}

resource "aws_cloudwatch_log_group" "ecs" {
  name              = "/ecs/main"
  retention_in_days = 7
}

```
