---
title: "LBã‚’ä½œã£ãŸã¨ãã«dualstackã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ipv4ã¨ipv6ã«åŒæ™‚ã«å¯¾å¿œã§ãã‚‹"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
tags: ["AWS", "Terraform"]
published: true
published_at: "2023-07-21 22:38"
---

# ã¯ã˜ã‚ã«

å…ˆæ—¥ã€route53 ã‚’çœºã‚ã¦ã„ãŸã‚‰ã€ã€Œdualstackã€ã‹ã‚‰å§‹ã¾ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã€‚
çµè«–ã‹ã‚‰è¨€ã†ã¨ã€ã€Œdualstackã€ã¨ã¯ **ipv4 ã¨ ipv6 ã«åŒæ™‚ã«å¯¾å¿œã§ãã‚‹æ©Ÿèƒ½** ã®ã“ã¨ã‚‰ã—ã„ã€‚

## ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã¯?

dualstack ã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹å‰ã«ã€**ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰** ã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹ã€‚

ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ã€route53 å›ºæœ‰ã®æ©Ÿèƒ½ã§ã€ã‚ã‚‹ AWS ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã™ã‚‹æ©Ÿèƒ½ã®ã“ã¨ã€‚å…·ä½“çš„ã«ã¯ã€AWS ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹ã¨ã€ãã® AWS ãƒªã‚½ãƒ¼ã‚¹å›ºæœ‰ã® DNS åãŒå‹æ‰‹ã«ä½œã‚‰ã‚Œã‚‹ã€‚(ä¾‹ãˆã°ã€hogehoge.ap-northeast-1.amazon.com)

ä¸»ãªä½¿ã„æ–¹ã¨ã—ã¦ã¯ã€A ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‘ãå…ˆã« ip ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ãªãã€ã“ã® DNS åã‚’æŒ‡å®šã™ã‚‹æ„Ÿã˜ã§ä½¿ã†ã€‚
ãã®æ„å‘³ã§ã¯ã€CNAME ãƒ¬ã‚³ãƒ¼ãƒ‰ã£ã½ã„ã€‚

## ãªãœã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå¿…è¦ãªã®ã‹?

A ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚„ AAAA ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‘ãå…ˆã¯ ip ã‚¢ãƒ‰ãƒ¬ã‚¹ã ãŒã€AWS ãƒªã‚½ãƒ¼ã‚¹ã¯ ip ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¯å¤‰ã®å ´åˆãŒå¤šã„ã€‚(å¤šåˆ†å†—é•·æ€§ã¨ã‹ã®ãŸã‚)

ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸ A ãƒ¬ã‚³ãƒ¼ãƒ‰ã ã£ãŸã‚‰ã€AWS ãƒªã‚½ãƒ¼ã‚¹ã® ip ãŒå¤‰ã‚ã£ã¦ã‚‚ã€DNS åãŒè‡ªå‹•çš„ã«æ–°ã—ã„ ip ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‘ã„ã¦ãã‚Œã‚‹ã®ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ãŸã‚Šã—ãªãã¦ã„ã„ã€‚

> ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ AWS ãƒªã‚½ãƒ¼ã‚¹ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã‚‹å ´åˆã€Route 53 ã¯ãƒªã‚½ãƒ¼ã‚¹ã§ã®å¤‰æ›´ã‚’è‡ªå‹•çš„ã«èªè­˜ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ example.com ãŒ lb1-1234.us-east-2.elb.amazonaws.com ã® ELB ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚’æŒ‡ã—ç¤ºã—ã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€Route 53 ãŒè‡ªå‹•çš„ã«é–‹å§‹ã•ã‚Œã€æ–°ã—ã„ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ç”¨ã—ã¦ DNS ã‚¯ã‚¨ãƒªã«å¿œç­”ã—ã¾ã™ã€‚

https://docs.aws.amazon.com/ja_jp/Route53/latest/DeveloperGuide/resource-record-sets-choosing-alias-non-alias.html

## dualstack ã¨ã¯?

ä»¥ä¸Šã‚’è¸ã¾ãˆã¦ã€**dualstack** ã¨ã¯ ipv4 ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ ipv6 ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸¡æ–¹ãŒå¼•ã‘ã‚‹ DNS åã®ã“ã¨(ã‚‚ã—ãã¯ã€ãã®æ©Ÿèƒ½ã®ã“ã¨?)

ã¤ã¾ã‚Šã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ©Ÿèƒ½ã‚’ç”¨ã„ã¦ã€A ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‘ãå…ˆã«ã‚‚ã§ãã‚‹ã—ã€AAAA ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‘ãå…ˆã«ã‚‚ã§ãã‚‹ DNS åã®ã“ã¨ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ã“ã® DNS åã¯ã€Œdualstackã€ã‹ã‚‰å§‹ã¾ã‚‹ã€‚

# å®Ÿé¨“ã—ã¦ã¿ã‚‹

åŸºæœ¬ãŒã‚ã‹ã£ãŸã¨ã“ã‚ã§ã€terraform ã§å®Ÿéš›ã«ä½œã£ã¦ã¿ã‚ˆã†ã¨æ€ã†ã€‚

ELB ã‚’ä½œã‚‹ã ã‘ã˜ã‚ƒãƒ¼ã‚“ã£ã¦æ€ã£ãŸã‘ã©ã€vpc ã® ipv6 å¯¾å¿œã¨ã‹ã‚ã‚“ã¾ã‚Šã—ãŸã“ã¨ãªãã¦å¾®å¦™ã«é¢å€’ã ã£ãŸã€‚

## terraform ã§ä½œã‚‹

ã–ã£ã¨ã§ããŸã‚‚ã®ãŒä»¥ä¸‹ã€‚

```hcl:alb/main.tf
locals {
  az = ["ap-northeast-1a", "ap-northeast-1c"]
}

resource "aws_vpc" "main" {
  cidr_block =  "10.0.0.0/16"
  assign_generated_ipv6_cidr_block = true

  tags = {
    Name = "dualstack-test-lb"
  }
}

resource "aws_subnet" "public" {
  count = 2
  vpc_id = aws_vpc.main.id
  cidr_block = cidrsubnet(aws_vpc.main.cidr_block, 8, count.index)
  ipv6_cidr_block = cidrsubnet(aws_vpc.main.ipv6_cidr_block, 8, count.index)
  availability_zone = local.az[count.index]

  tags = {
    Name = "dualstack-test-lb-public${count.index}}"
  }
}

resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "dualstack-test-lb-igw"
  }
}

resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }
}

resource "aws_route_table_association" "public" {
  count = 2
  subnet_id = aws_subnet.public[count.index].id
  route_table_id = aws_route_table.public.id
}

resource "aws_security_group" "lb_sg" {
  name = "dualstack-test-lb-sg"
  description = "Used in the terraform"
  vpc_id = aws_vpc.main.id

  ingress {
    from_port = 80
    to_port = 80
    protocol = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port = 0
    to_port = 0
    protocol = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_lb" "main" {
  name = "dualstack-test-lb"
  internal = false
  load_balancer_type = "application"
  security_groups = [ aws_security_group.lb_sg.id ]
  subnets = aws_subnet.public.*.id
  ip_address_type = "ipv4" # dualstack or ipv4
  enable_deletion_protection = false

  tags = {
    Name = "dualstack-test-lb"
  }
}

resource "aws_lb_listener" "http" {
  load_balancer_arn = aws_lb.main.arn
  port = 80
  protocol = "HTTP"

  default_action {
    type = "fixed-response"

    fixed_response {
      content_type = "text/plain"
      message_body = "Hello, World"
      status_code = "200"
    }
  }
}

```

## dig ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿé¨“

terraform ã§ AWS ãƒªã‚½ãƒ¼ã‚¹ãŒã§ããŸã‚‰ã€ELB ã® DNS åã‚’ã¨ã£ã¦ãã¦ã€dig ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿé¨“ã—ã¦ã¿ãŸã€‚

ã¡ãªã¿ã«ã€dig ã‚³ãƒãƒ³ãƒ‰ã¯`+short` ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã ã‘å‡ºåŠ›ã§ãã‚‹ã€‚

```bash:Aãƒ¬ã‚³ãƒ¼ãƒ‰
dig (dnså) +short # ipv4ã‚’å¼•ã
```

ipv6 ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ dig ã‚³ãƒãƒ³ãƒ‰ã§å¼•ãã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜

```bash:AAAAãƒ¬ã‚³ãƒ¼ãƒ‰
# -t = type : DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç¨®é¡
# @8.8.8.8  : DNSã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦ã¯ipv6å¯¾å¿œã—ã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§Google Public DNS(8.8.8.8)ã‚’DNSã‚µãƒ¼ãƒãƒ¼ã«æŒ‡å®šã—ã¦å•ã„åˆã‚ã›
dig -t AAAA @8.8.8.8 (dnså) +short # ipv6ã‚’å¼•ã
```
