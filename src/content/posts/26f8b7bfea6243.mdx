---
title: "aws-cdkã‚’ä½¿ã£ã¦s3+cloudfrontã®é™çš„ã‚µã‚¤ãƒˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½œã‚‹"
emoji: "ğŸ’¬"
type: "tech"
tags:
  - "AWS"
  - "TypeScript"
published: true
published_at: "2023-06-04 13:34"
---

# ã¯ã˜ã‚ã«

aws-cli ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™

```bash:aws-cliã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
brew install awscli # aws-cliã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
aws --versionã€€# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã“ã¨ã®ç¢ºèª
```

`aws configure`ã§ profile ã®è¨­å®šã‚’ã—ã¦ãŠãã¾ã™

```bash:awsã®profileã®è¨­å®š
aws configure # defaultã€€ã¨ã„ã†profileåã§ä½œæˆ
# ã‚‚ã—ãã¯ aws configure --profile user1ã€€ãªã©ã§defaultä»¥å¤–ã®profileåã§ä½œæˆã—ã¦ã‚‚ã‚ˆã„

# ä»¥ä¸‹ã®é …ç›®ãŒèã‹ã‚Œã‚‹ã®ã§ã€åŸ‹ã‚ã‚‹
AWS Access Key ID [None]: {ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼(å„è‡ª)}
AWS Secret Access Key [None]: {ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼(å„è‡ª)}
Default region name [None]: ap-northeast-1
Default output format [None]: json (ã¾ãŸã¯ yaml, text ãªã©)
```

```bash:awsã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ã¦ã¿ã‚‹
aws sts get-caller-identity # å‘¼ã³å‡ºã—ãŸäººã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãªã©ã‚’å–å¾—
# profileã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯ aws sts get-caller-identity --profile user1ã€€ãªã©ã¨ã™ã‚‹

aws configure list # default profileã®è¨­å®šã‚’ç¢ºèª
awsã€€iam list-users # IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã‚’ç¢ºèª
```

https://qiita.com/reflet/items/e4225435fe692663b705

https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-usage-output-format.html

# ä½œã£ã¦ã„ã

## å‰æ

- è¨€èªã¯ typescript ã§è¡Œã„ã¾ã™
- ã‚¨ãƒ‡ã‚£ã‚¿ã¯ vscode ã‚’ä½¿ã„ã¾ã™
- node: 18.13.0(20 ç³»ã ã¨ aws-cdk ãŒã¾ã å¯¾å¿œã—ã¦ãªã„ã¿ãŸã„ãªè­¦å‘ŠãŒå‡ºãŸã®ã§ 18 ã§ã‚„ã£ã¦ã¿ã¾ã™)
- npm: 8.19.3

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ

```bash:ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir zenn-cdk
cd zenn-cdk
git init
cd cdk
npx cdk init app --language typescript
```

```bash: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
$ tree -aL 2
.
â”œâ”€â”€ .git
â”‚   â”œâ”€â”€ HEAD
â”‚   â”œâ”€â”€ config
â”‚   â”œâ”€â”€ description
â”‚   â”œâ”€â”€ hooks
â”‚   â”œâ”€â”€ info
â”‚   â”œâ”€â”€ objects
â”‚   â””â”€â”€ refs
â”œâ”€â”€ .vscode
â”‚   â”œâ”€â”€ extensions.json
â”‚   â””â”€â”€ settings.json
â””â”€â”€ cdk
    â”œâ”€â”€ .gitignore
    â”œâ”€â”€ .npmignore
    â”œâ”€â”€ README.md
    â”œâ”€â”€ bin
    â”œâ”€â”€ cdk.json
    â”œâ”€â”€ jest.config.js
    â”œâ”€â”€ lib
    â”œâ”€â”€ node_modules
    â”œâ”€â”€ package-lock.json
    â”œâ”€â”€ package.json
    â”œâ”€â”€ test
    â””â”€â”€ tsconfig.json
```

## vscode ã®è¨­å®š(é£›ã°ã—ã¦ã‚‚ OK)

å€‹äººã®è¶£å‘ãªã®ã§ã€é©å½“ã«ã‚«ã‚¹ã‚¿ãƒ ã—ã¦ãã ã•ã„

```json:.vscode/extensions.json
{
  "recommendations": [
    "esbenp.prettier-vscode", // typescriptã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹
    "amazonwebservices.aws-toolkit-vscode", // vscodeä¸Šã§awsãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ãŸã‚Šã§ãã‚‹
  ]
}
```

```json:.vscode/settings.json
{
    "editor.defaultFormatter": "esbenp.prettier-vscode",
    "editor.formatOnSave": true,
    "editor.tabSize": 2,
}
```

```json:.prettierrc
{
  "trailingComma": "all",
  "tabWidth": 2,
  "singleQuote": true,
  "semi": true
}
```

## cdk bootstrap

```bash:cdk-bootstrap
npx cdk bootstrap # default profileã§è¨­å®š
# ã‚‚ã—ãã¯ cdk bootstrap aws://XXXXXXXX/ap-northeast-1 --profile cm-wada ãªã©
```

## s3 ã¨ cloudfront ã‚’ä½œã‚‹

```ts:lib/cdk-stack.ts
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';

export class CdkStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // é™çš„ã‚µã‚¤ãƒˆãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ç”¨ã®ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
    const bucket = new cdk.aws_s3.Bucket(this, 'ZennCdkTestBucket', {
      bucketName: 'zenn-cdk-test-bucket',
      removalPolicy: cdk.RemovalPolicy.DESTROY, // ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤æ™‚(npx cdk destroyå®Ÿè¡Œæ™‚)ã«ãƒã‚±ãƒƒãƒˆã‚‚å‰Šé™¤(ãŸã ã—ã€s3ã®ä¸­èº«ã‚’ç©ºã«ã—ã¦ãŠã‹ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹)
    });

    // cloudfrontç”¨ã®originAccessIdentityã‚’ä½œæˆ
    const originAccessIdentity = new cdk.aws_cloudfront.OriginAccessIdentity(
      this,
      'OriginAccessIdentity',
      {
        comment: 'OriginAccessIdentityForStaticSiteHostingBucket',
      },
    );

    // bucket policyã‚’ä½œæˆ
    const bucketPolicy = new cdk.aws_iam.PolicyStatement({
      actions: ['s3:GetObject'], // GetObjectã®ã¿è¨±å¯
      resources: [`${bucket.bucketArn}/*`], // ãƒã‚±ãƒƒãƒˆå†…ã®å…¨ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¯¾è±¡
      // originAccessIdentityã‹ã‚‰(CloudFrontçµŒç”±ã§ã®ã‚¢ã‚¯ã‚»ã‚¹)ã®ã¿ã‚’è¨±å¯
      principals: [
        new cdk.aws_iam.CanonicalUserPrincipal(
          originAccessIdentity.cloudFrontOriginAccessIdentityS3CanonicalUserId,
        ),
      ],
    });

    // bucketã«policyã‚’è¿½åŠ 
    bucket.addToResourcePolicy(bucketPolicy);

    // cloudfrontã®è¨­å®š
    const distribution = new cdk.aws_cloudfront.Distribution(
      this,
      'distribution',
      {
        comment: 'DistributionForStaticSiteHostingBucket',
        defaultRootObject: 'index.html', // index.htmlã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã«è¨­å®š
        defaultBehavior: {
          compress: true, // åœ§ç¸®ã‚’æœ‰åŠ¹åŒ–
          viewerProtocolPolicy:
            cdk.aws_cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS, // httpã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’httpsã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          allowedMethods: cdk.aws_cloudfront.AllowedMethods.ALLOW_GET_HEAD, // GETã¨HEADã®ã¿è¨±å¯
          origin: new cdk.aws_cloudfront_origins.S3Origin(bucket, {
            originAccessIdentity,
          }),
        },
      },
    );

    // s3ã«ãƒ‡ãƒ—ãƒ­ã‚¤
    new cdk.aws_s3_deployment.BucketDeployment(this, 'BucketDeployment', {
      destinationBucket: bucket,
      distribution,
      sources: [
        cdk.aws_s3_deployment.Source.data(
          '/index.html',
          '<html><body><h1>Hello, World!</h1></body></html>',
        ),
      ],
    });

    // cloudfrontã®URLã‚’å‡ºåŠ›
    // CfnOutputã¯cdkã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã«å‡ºåŠ›ã•ã‚Œã‚‹å€¤ã‚’å‡ºåŠ›ã™ã‚‹æ™‚ã«ä½¿ã†
    // å‚è€ƒ: https://zenn.dev/winteryukky/articles/5e5353ae72ab5c
    new cdk.CfnOutput(this, 'URL', {
      value: `https://${distribution.distributionDomainName}`,
    });
  }
}
```

https://zenn.dev/winteryukky/articles/5e5353ae72ab5c

https://dev.classmethod.jp/articles/aws-cdk-s3-delete-policy/

## ãƒ‡ãƒ—ãƒ­ã‚¤

```bash:ãƒ‡ãƒ—ãƒ­ã‚¤
npm run build # tscãŒå®Ÿè¡Œã•ã‚Œã‚‹, å¿µã®ç‚ºã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
# æœ¬å½“ã¯jestã§ãƒ†ã‚¹ãƒˆæ›¸ã„ã¦ã€npm testãŒé€šã‚‹ã“ã¨ç¢ºèªã¨ã‹ã—ãŸã„

npx cdk synth # CDKã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰CFnã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹
# ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«vscodeã®aws toolkitã¨ã‹ã§stackã®å†…å®¹ã‚’ç¢ºèªã—ã¦ãŠãã®ã‚‚ãŠã™ã™ã‚

npx cdk deploy # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰

# Outputs:
# CdkStack.URL = https://hogehoge.cloudfront.net
```

url ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ Hello world!ã¨å‡ºãŸã‚‰ OK ã§ã™
s3 ã® index.html ã«ç›´ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªã„ã“ã¨ã‹ã‚‰ OAI ã‚‚åŠ¹ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºã‹ã‚ã¾ã™
ã•ã‚‰ã«ã€cloudformation ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€stack ãŒã§ãã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºã‹ã‚ã‚‹ã¨ã‚ˆã‚Šå‹‰å¼·ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“

## ãŠç‰‡ä»˜ã‘

- s3 ã®ä¸­èº«ã‚’ç©ºã«ã™ã‚‹
- `npx cdk destroy`
- cloudformation ã§ stack ãŒããˆã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹
- URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹
