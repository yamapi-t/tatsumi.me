---
title: "aws-cdkã§lambdaã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹CIã‚’ä½œã‚‹"
emoji: "ğŸ’¡"
type: "tech"
tags:
  - "AWS"
  - "TypeScript"
published: true
published_at: "2023-06-09 10:39"
---

# åˆæœŸè¨­å®šãªã©

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„

https://tatsumime-tatsumiyamamotos-projects.vercel.app/articles/26f8b7bfea6243

# ä½œã‚‹ã‚‚ã®

ä»¥ä¸‹ã®ã‚ˆã†ãª CI ã‚’ä½œã‚Šã¾ã™

1. github ã« push
2. codebuild ã®ãƒãƒã‚³ãƒ³ã®ã€Œãƒ“ãƒ«ãƒ‰é–‹å§‹ã€ã‚’æŠ¼ã™(ã‚‚ã—ãã¯ aws ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰èµ·å‹•ã™ã‚‹)
3. codebuild ãŒ github ã®ç‰¹å®šã®ãƒªãƒã‚¸ãƒˆãƒªã® main ãƒ–ãƒ©ãƒ³ãƒã‚’å‚ç…§ã—ã€Dockerfile ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒ ECR ã«ç½®ã‹ã‚Œã€lambda ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹

![æ§‹æˆå›³](/images/compressed-images/codebuild-ecr-lambda.png)

# lambda ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½œæˆ

lambdan ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã£ã¦ã„ãã¾ã™

```python:src/app.py
import sys


def handler(event, context) -> str:
    return "Hello from AWS Lambda using Python" + sys.version + "!"
```

```dockerfile:src/Dockerfile
FROM public.ecr.aws/lambda/python:3.10

COPY requirements.txt ./

RUN pip3 install -r requirements.txt --target "${LAMBDA_TASK_ROOT}"

COPY app.py ${LAMBDA_TASK_ROOT}

CMD ["app.handler"]
```

# ã‚³ãƒ³ãƒ†ãƒŠã®å‹•ä½œãƒ†ã‚¹ãƒˆ

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™

```bash:ãƒ­ãƒ¼ã‚«ãƒ«ã§dockerã®ãƒ†ã‚¹ãƒˆ
docker build . -t test
docker run --rm -it -p 9000:8000 test
```

localhost ã® 9000 ç•ªãƒãƒ¼ãƒˆã®ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã® lambda ã®å®Ÿè¡Œãƒ†ã‚¹ãƒˆãŒã§ãã¾ã™

```bash:ãƒ­ãƒ¼ã‚«ãƒ«ã§lambdaã®å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
curl -X POST http://localhost:9000/2015-03-31/functions/function/invocations -d {} # lambdaã®å‘¼ã³å‡ºã—
```

https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/images-test.html

# aws-cdk ã®ã‚³ãƒ¼ãƒ‰

ã–ã£ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã«ãªã£ãŸã¨ã„ã†ã®ã‚’æ›¸ã„ã¦ã¿ã¾ã™
aws-cdk ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹çš„ãªã‚‚ã®ã‚’çŸ¥ã‚‰ãªã„ã®ã§ã€ã‚ˆã‚Šã„ã„ã‚„ã‚Šæ–¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„

```typescript:cdk/libs/ecr-stack.ts
import {
  App,
  Duration,
  RemovalPolicy,
  Stack,
  StackProps,
  aws_codebuild,
  aws_ecr,
  aws_iam,
  aws_lambda,
} from 'aws-cdk-lib';
import 'dotenv/config'; # ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿

const REGION = process.env.AWS_DEFAULT_REGION ?? '';
const ACCOUNT_ID = process.env.AWS_ACCOUNT_ID ?? '';
const OWNER = process.env.GITHUB_OWNER ?? '';
const REPO = process.env.GITHUB_REPO ?? '';
const BRANCH = process.env.GITHUB_BRANCH ?? '';

export class EcrStack extends Stack {
  constructor(scope: App, id: string, props?: StackProps) {
    super(scope, id, props);

    const ecr = new aws_ecr.Repository(this, 'ZennCdkRepository', {
      repositoryName: 'zenn-cdk-repository',
      removalPolicy: RemovalPolicy.DESTROY, // ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤æ™‚(npx cdk destroyå®Ÿè¡Œæ™‚)ã«repositoryã‚‚å‰Šé™¤
      autoDeleteImages: true, // repositoryå‰Šé™¤æ™‚ã«container imageã‚‚å‰Šé™¤
    });

    // buildSpecã‚’jsã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ã§è¨˜è¿°ã™ã‚‹
    const buildSpec = {
      version: '0.2',
      phases: {
        pre_build: {
          commands: [
            'echo "Logging in to Amazon ECR..."',
            'aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com',
          ],
        },
        build: {
          commands: [
            'echo "Building the Docker image..."',
            'docker build -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/zenn-cdk-repository:latest -f cdk-ecr-lambda/src/Dockerfile cdk-ecr-lambda/src',
          ],
        },
        post_build: {
          commands: [
            'echo "Pushing the Docker image..."',
            'docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/zenn-cdk-repository:latest',
            // lambdaã¯ecrã«imageãŒãªã„ã¨å¤±æ•—ã™ã‚‹ã®ã§ã€åˆå›ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆãªã©ã—ã¦å¯¾å¿œã™ã‚‹
            // ãªã«ã‹ã„ã„æ–¹æ³•ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„
            'aws lambda update-function-code --function-name zenn-cdk-lambda --image $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/zenn-cdk-repository:latest',
          ],
        },
      },
    };

    const codebuildRole = new aws_iam.Role(this, 'ZennCdkCodebuildRole', {
      roleName: 'zenn-cdk-codebuild-role',
      assumedBy: new aws_iam.ServicePrincipal('codebuild.amazonaws.com'),
    });

    // ecrã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’codebuildã«ä»˜ä¸
    codebuildRole.addManagedPolicy(
      aws_iam.ManagedPolicy.fromAwsManagedPolicyName(
        'AmazonEC2ContainerRegistryPowerUser',
      ),
    );

    // lambdaã®updateæ¨©é™ã‚’codebuildã«ä»˜ä¸(ã‚ã‚“ã©ã„ã®ã§ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã¤ã‘ã¦ã„ã‚‹)
    codebuildRole.addManagedPolicy(
      aws_iam.ManagedPolicy.fromAwsManagedPolicyName('AWSLambda_FullAccess'),
    );

    const codebuild = new aws_codebuild.Project(this, 'ZennCdkCodebuild', {
      projectName: 'zenn-cdk-codebuild',
      source: aws_codebuild.Source.gitHub({
        owner: OWNER,
        repo: REPO,
        branchOrRef: BRANCH,
        webhook: false, // GitHubã‹ã‚‰ã®Webhookã‚’ç„¡åŠ¹åŒ–
      }),
      buildSpec: aws_codebuild.BuildSpec.fromObject(buildSpec),
      environment: {
        privileged: true, // dockerã‚’å‹•ã‹ã™ã®ã§sudoæ¨©é™ã‚’ä»˜ä¸
        buildImage: aws_codebuild.LinuxBuildImage.STANDARD_7_0, // Dockerfileã‚’ã©ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸Šã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã‹
        environmentVariables: {
          AWS_ACCOUNT_ID: {
            type: aws_codebuild.BuildEnvironmentVariableType.PLAINTEXT,
            value: ACCOUNT_ID,
          },
          AWS_DEFAULT_REGION: {
            type: aws_codebuild.BuildEnvironmentVariableType.PLAINTEXT,
            value: REGION,
          },
        },
      },
      role: codebuildRole,
      cache: aws_codebuild.Cache.local(
        aws_codebuild.LocalCacheMode.DOCKER_LAYER,
      ),
    });

    // lambdaã¯ecrã«imageãŒãªã„ã¨å¤±æ•—ã™ã‚‹ã®ã§ã€åˆå›ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆãªã©ã—ã¦å¯¾å¿œã™ã‚‹(ãªã«ã‹ã„ã„æ–¹æ³•ãŒã‚ã‚Œã°çŸ¥ã‚ŠãŸã„...)
    const lambda = new aws_lambda.Function(this, 'ZennCdkLambda', {
      functionName: 'zenn-cdk-lambda',
      code: aws_lambda.Code.fromEcrImage(ecr, {
        cmd: ['app.handler'],
        tagOrDigest: 'latest',
      }),
      runtime: aws_lambda.Runtime.FROM_IMAGE,
      handler: aws_lambda.Handler.FROM_IMAGE,
      timeout: Duration.seconds(3),
    });
  }
}
```

# ECR ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãªã„ã¨ lambda ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã™ã‚‹

åˆå›ã¯ ECR ã«ä½•ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã„ã®ã§ã€lambda ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ã€Œã‚¤ãƒ¡ãƒ¼ã‚¸ãªã„ã‚„ã‚“ã‘ï¼ã€ã¿ãŸã„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã‚ã£ãŸã‚‰ãã£ã¡ã€ãªã‹ã£ãŸã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼Ÿã¿ãŸã„ãªåˆ‡ã‚Šæ›¿ãˆãŒã§ãã‚Œã°ãªã‚ã¨æ€ã£ã¦ã„ã¾ã™(ã‚„ã‚Šæ–¹çŸ¥ã£ã¦ã„ã‚‹æ–¹ã„ã‚Œã°æ•™ãˆã¦ã»ã—ã„ã§ã™)

```ts:lambdaã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã™ã‚‹
// lambdaã¯ecrã«imageãŒãªã„ã¨å¤±æ•—ã™ã‚‹ã®ã§ã€åˆå›ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆãªã©ã—ã¦å¯¾å¿œã™ã‚‹(ãªã«ã‹ã„ã„æ–¹æ³•ãŒã‚ã‚Œã°çŸ¥ã‚ŠãŸã„...)
const lambda = new aws_lambda.Function(this, "ZennCdkLambda", {
  functionName: "zenn-cdk-lambda",
  code: aws_lambda.Code.fromEcrImage(ecr, {
    cmd: ["app.handler"],
    tagOrDigest: "latest",
  }),
  runtime: aws_lambda.Runtime.FROM_IMAGE,
  handler: aws_lambda.Handler.FROM_IMAGE,
  timeout: Duration.seconds(3),
});
```

# aws-cdk ã«ãŠã‘ã‚‹ç’°å¢ƒå¤‰æ•°ã®æ‰±ã„ã«ã¤ã„ã¦

ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™

https://maku.blog/p/vx5ta85/

å¤šåˆ†ä¸Šã®ã‚³ãƒ¼ãƒ‰ã¯ç’°å¢ƒå¤‰æ•°çš„ã«ã„ã„ã‚„ã‚Šæ–¹ã§ã¯ãªã„ã®ã§ã™ãŒã€å­¦ç¿’ç”¨ã®ã‚³ãƒ¼ãƒ‰ã ã£ãŸã®ã§ã¾ã‚ã„ã£ã‹ã¨...

# github ã¨ã®é€£æºã«ã¯ä»¥ä¸‹ã®æ‰‹é †ãŒå¿…è¦

github ã¨ codebuild ã®é€£æºã«ã¯ä»¥ä¸‹ã®æ‰‹é †ãŒäº‹å‰ã«å¿…è¦ã§ã™
github ã‹ã‚‰ token ã‚’ç™ºè¡Œã—ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™

```bash:codebuildã®åˆå›è¨­å®š
aws codebuild import-source-credentials --server-type GITHUB --auth-type PERSONAL_ACCESS_TOKEN --token <token_value>
```

https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_codebuild-readme.html

# ãƒ‡ãƒ—ãƒ­ã‚¤

```bash:ãƒ‡ãƒ—ãƒ­ã‚¤
npx cdk deploy # lambdaãŒåˆå›ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§æ³¨æ„
git add -A
git commit -m 'aws-cdkã®ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã€€'
git push
```

# codebuild ã®ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹ã™ã‚‹

ãƒãƒã‚³ãƒ³ã‹ã‚‰ã€Œãƒ“ãƒ«ãƒ‰é–‹å§‹ã€ã‚’æŠ¼ã™ã‹ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™

```bash:ãƒ“ãƒ«ãƒ‰é–‹å§‹ã‚³ãƒãƒ³ãƒ‰
aws codebuild start-build --project-name zenn-cdk-codebuild
```

codebuild ãŒæˆåŠŸã—ãŸã‚‰ lambda ã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¦çµ‚äº†ã§ã™

# ãŠç‰‡ä»˜ã‘

```bash:stuckã‚’å‰Šé™¤ã™ã‚‹
npx cdk destroy
```
